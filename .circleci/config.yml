# ========================================
# CircleCI Self-hosted Runner ãƒ‡ãƒ¢è¨­å®š
# ========================================
# ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€CircleCIã®Self-hosted Runneræ©Ÿèƒ½ã®ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã§ã™ã€‚
# Self-hosted Runnerã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãŠå®¢æ§˜ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ä¸Šã§CIã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚
#
# ğŸ“š å‚è€ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:
# - Runneræ¦‚è¦: https://circleci.com/docs/guides/execution-runner/runner-overview/
# - Runneræ¦‚å¿µï¼ˆNamespace/Resource Classï¼‰: https://circleci.com/docs/guides/execution-runner/runner-concepts/
# - Machine Runnerã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆLinuxï¼‰: https://circleci.com/docs/guides/execution-runner/runner-installation-linux/
# - Machine Runnerã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆmacOSï¼‰: https://circleci.com/docs/guides/execution-runner/runner-installation-mac/
# - Container Runnerã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆKubernetesï¼‰: https://circleci.com/docs/guides/execution-runner/container-runner-installation/
# - Machine Runneræ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: https://circleci.com/docs/guides/execution-runner/machine-runner-3-manual-installation/
#
# ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †:
# 1. CircleCIã®Webã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã€ŒSelf-Hosted Runnersã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹
# 2. æ–°ã—ã„Runner Resource Classã‚’ä½œæˆï¼ˆä¾‹: <namespace>/<resource-class-name>ï¼‰
# 3. æä¾›ã•ã‚Œã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦Runnerã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# 4. ä¸‹è¨˜ã®`resource_class`ã‚’ä½œæˆã—ãŸResource Classã«æ›´æ–°
# ========================================

version: 2.1

# Orbs: å†åˆ©ç”¨å¯èƒ½ãªè¨­å®šãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
orbs:
  node: circleci/node@7.2.1  # Node.jsãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆç”¨ã®orb

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œé †åºã‚’å®šç¾©
workflows:
  testing:
    jobs:
      # Self-hosted Runnerã§å®Ÿè¡Œã•ã‚Œã‚‹ç°¡å˜ãªãƒ‡ãƒ¢ã‚¸ãƒ§ãƒ–
      - runner-hello
      
      # Self-hosted Runnerã§Node.js Orbã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã‚¸ãƒ§ãƒ–
      - runner-test-with-orb
      
      # CircleCIæ¨™æº–ã®ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã‚‹Node.jsãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–ï¼ˆæ¯”è¼ƒç”¨ï¼‰
      - node/test:
          pkg-manager: npm
          run-command: test:ci

# ã‚¸ãƒ§ãƒ–å®šç¾©
jobs:
  # Self-hosted Runner ç°¡å˜ãªãƒ‡ãƒ¢ã‚¸ãƒ§ãƒ–
  # RunnerãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®æœ€å°é™ã®ã‚¸ãƒ§ãƒ–
  runner-hello:
    # machine: trueã¯ã€Docker Executorã§ã¯ãªãå°‚ç”¨ã®ãƒã‚·ãƒ³ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’æŒ‡å®š
    machine: true
    
    # âš ï¸ é‡è¦: resource_classã‚’å®Ÿéš›ã«ä½œæˆã—ãŸRunner Resource Classã«ç½®ãæ›ãˆã¦ãã ã•ã„
    # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: <namespace>/<resource-class-name>
    # ä¾‹: your-org/my-runner, your-company/production-runner
    resource_class: hidetaka/first-local-runner
    
    steps:
      # Self-hosted Runnerä¸Šã§å®Ÿè¡Œã•ã‚Œã‚‹ç°¡å˜ãªãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰
      - run: echo "Hi I'm on Runners!"
      
      # è¿½åŠ ã®ã‚¹ãƒ†ãƒƒãƒ—ä¾‹ï¼ˆå¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã—ã¦ä½¿ç”¨ï¼‰:
      # - run: 
      #     name: ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã®è¡¨ç¤º
      #     command: |
      #       echo "Hostname: $(hostname)"
      #       echo "OS: $(uname -a)"

  # Self-hosted Runner + Node.js Orb ã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–
  # node/testã‚¸ãƒ§ãƒ–ã¨åŒç­‰ã®å‡¦ç†ã‚’Self-hosted Runnerä¸Šã§å®Ÿè¡Œ
  runner-test-with-orb:
    # machine: trueã¯ã€Docker Executorã§ã¯ãªãå°‚ç”¨ã®ãƒã‚·ãƒ³ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’æŒ‡å®š
    machine: true
    
    # âš ï¸ é‡è¦: resource_classã‚’å®Ÿéš›ã«ä½œæˆã—ãŸRunner Resource Classã«ç½®ãæ›ãˆã¦ãã ã•ã„
    # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: <namespace>/<resource-class-name>
    # ä¾‹: your-org/my-runner, your-company/production-runner
    resource_class: hidetaka/first-local-runner
    
    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - checkout

      # ----------------------------------------
      # åˆå¿ƒè€…å‘ã‘ãƒ¡ãƒ¢: ãªãœã€ŒNode/npmã®åˆæœŸåŒ–ã€ãŒå¿…è¦ï¼Ÿ
      # ----------------------------------------
      # å‰æ: Node.js ã‚’ fnm/nodenv/asdf/nvm ç­‰ã® â€œãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãƒ„ãƒ¼ãƒ«â€ ã§å…¥ã‚Œã¦ã„ã‚‹å ´åˆã€
      #       `node`/`npm` ã¯ãƒ„ãƒ¼ãƒ«ãŒ PATH ã‚’æ›¸ãæ›ãˆã‚‹ã“ã¨ã§åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
      #
      # self-hosted runner (machine: true) ã®å„ step ã¯ /bin/bash ã§å®Ÿè¡Œã•ã‚Œã¾ã™ãŒã€
      # ãƒ­ã‚°ã‚¤ãƒ³ã‚·ã‚§ãƒ«ã®åˆæœŸåŒ– (.zshrc / .bashrc ç­‰) ã¯é€šå¸¸èª­ã¿è¾¼ã¾ã‚Œã¾ã›ã‚“ã€‚
      # ãã®çµæœã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãƒ„ãƒ¼ãƒ«ãŒè¿½åŠ ã™ã‚‹ PATH ãŒåæ˜ ã•ã‚Œãšã€
      # ãƒ­ãƒ¼ã‚«ãƒ«ã§ã¯ `npm -v` ãŒé€šã£ã¦ã„ã¦ã‚‚ CI ã§ã¯ `npm: command not found` ã«ãªã‚Šå¾—ã¾ã™ã€‚
      #
      # ã“ã®ãƒ‡ãƒ¢ã§ã¯ Node/npm ã‚’ fnmï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼é ˜åŸŸï¼‰ã§ç®¡ç†ã™ã‚‹æƒ³å®šãªã®ã§ã€
      # ã¾ãšã€Œfnm ã‚’ PATH ã«å…¥ã‚Œã‚‹ã€â†’ã€Œfnm env ã‚’èª­ã¿è¾¼ã‚€ã€â†’ã€Œnpm ãŒè¦‹ãˆã‚‹ã‹ç¢ºèªã€
      # ã‚’è¡Œã„ã€ä»¥é™ã® stepï¼ˆorb ã® step å«ã‚€ï¼‰ã§ã‚‚æœ‰åŠ¹ã«ãªã‚‹ã‚ˆã† $BASH_ENV ã«æ›¸ãè¾¼ã¿ã¾ã™ã€‚
      #
      # âš ï¸ æ³¨æ„: å—è¬›è€…ãŒä½¿ã†ãƒ„ãƒ¼ãƒ«ã¯ç’°å¢ƒã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚
      # ãã®å ´åˆã¯ã€ã“ã® step ã® â€œåˆæœŸåŒ–éƒ¨åˆ†â€ ã‚’è‡ªåˆ†ã®ç’°å¢ƒã«åˆã‚ã›ã¦ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
      # - ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãƒ„ãƒ¼ãƒ«åˆ©ç”¨: ãã®ãƒ„ãƒ¼ãƒ«ã®åˆæœŸåŒ–ï¼ˆPATHè¿½åŠ  / envå‡ºåŠ›ã®evalç­‰ï¼‰ã‚’å®Ÿè¡Œ
      # - ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãƒ„ãƒ¼ãƒ«ä¸ä½¿ç”¨: `node`/`npm` ãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ PATH ã«è¿½åŠ 
      #
      # é‡è¦: orb ã® `node/install-packages` ã‚ˆã‚Šå‰ã«ã€npm ãŒè§£æ±ºã§ãã‚‹çŠ¶æ…‹ã«ã™ã‚‹ã“ã¨ã€‚
      # ----------------------------------------
      - run:
          name: Initialize Node/npm (demo uses fnm)
          command: |
            set -euo pipefail

            # 1) fnm ã®å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
            #    â€» fnmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å ´æ‰€ã¯ç’°å¢ƒã«ã‚ˆã‚Šç•°ãªã‚Šã¾ã™ãŒã€ã“ã®ãƒ‡ãƒ¢ã¯ $HOME/.fnm ã‚’æƒ³å®šã—ã¾ã™ã€‚
            if [ -d "$HOME/.fnm" ]; then
              echo 'export PATH="$HOME/.fnm:$PATH"' >> "$BASH_ENV"
            fi

            # 2) fnm ãŒç”¨æ„ã™ã‚‹ã€ŒNode/npmã®PATHè¨­å®šã€ã‚’èª­ã¿è¾¼ã‚€
            #    - CircleCI ã§ã¯ã€å„ step ã®é–‹å§‹æ™‚ã« $BASH_ENV ãŒ source ã•ã‚Œã¾ã™ã€‚
            #      ã“ã“ã«æ›¸ãè¾¼ã‚€ã¨ã€æ¬¡ã® stepï¼ˆorbã®stepå«ã‚€ï¼‰ã§ã‚‚è¨­å®šãŒå¼•ãç¶™ãŒã‚Œã¾ã™ã€‚
            #    - `fnm env --shell bash` ã¯ bash ç”¨ã® export ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚
            echo 'if command -v fnm >/dev/null 2>&1; then eval "$(fnm env --shell bash)"; fi' >> "$BASH_ENV"

            # 3) ã“ã® step å†…ã§ã‚‚æœ‰åŠ¹åŒ–ã—ã¦ã€ãƒ­ã‚°ã§ç¢ºèªã§ãã‚‹ã‚ˆã†ã«å‡ºåŠ›
            source "$BASH_ENV"
            echo "[debug] PATH=$PATH"
            echo "[debug] fnm=$(command -v fnm || true)"
            echo "[debug] node=$(command -v node || true)"
            echo "[debug] npm=$(command -v npm || true)"
            fnm --version
            node -v
            npm -v
      
      # Node.js Orbã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # node/install-packagesã¯ã€package-lock.json/yarn.lockç­‰ã‚’æ¤œå‡ºã—ã€
      # é©åˆ‡ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
      - node/install-packages:
          pkg-manager: npm
      
      # ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒã¨åŒã˜ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
      - run:
          name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          command: npm run test:ci
      
      # è¿½åŠ ã®ã‚¹ãƒ†ãƒƒãƒ—ä¾‹ï¼ˆå¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã—ã¦ä½¿ç”¨ï¼‰:
      # - run:
      #     name: ã‚«ã‚¹ã‚¿ãƒ ãƒ“ãƒ«ãƒ‰å‡¦ç†
      #     command: npm run build
