# ========================================
# CircleCI Self-hosted Runner ãƒ‡ãƒ¢è¨­å®š
# ========================================
# ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€CircleCIã®Self-hosted Runneræ©Ÿèƒ½ã®ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã§ã™ã€‚
# Self-hosted Runnerã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãŠå®¢æ§˜ã®ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ä¸Šã§CIã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚
#
# ğŸ“š å‚è€ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:
# - Runneræ¦‚è¦: https://circleci.com/docs/guides/execution-runner/runner-overview/
# - Runneræ¦‚å¿µï¼ˆNamespace/Resource Classï¼‰: https://circleci.com/docs/guides/execution-runner/runner-concepts/
# - Machine Runnerã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆLinuxï¼‰: https://circleci.com/docs/guides/execution-runner/runner-installation-linux/
# - Machine Runnerã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆmacOSï¼‰: https://circleci.com/docs/guides/execution-runner/runner-installation-mac/
# - Container Runnerã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆKubernetesï¼‰: https://circleci.com/docs/guides/execution-runner/container-runner-installation/
# - Machine Runneræ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«: https://circleci.com/docs/guides/execution-runner/machine-runner-3-manual-installation/
#
# ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †:
# 1. CircleCIã®Webã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã€ŒSelf-Hosted Runnersã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹
# 2. æ–°ã—ã„Runner Resource Classã‚’ä½œæˆï¼ˆä¾‹: <namespace>/<resource-class-name>ï¼‰
# 3. æä¾›ã•ã‚Œã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦Runnerã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# 4. ä¸‹è¨˜ã®`resource_class`ã‚’ä½œæˆã—ãŸResource Classã«æ›´æ–°
# ========================================

version: 2.1

# Orbs: å†åˆ©ç”¨å¯èƒ½ãªè¨­å®šãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
orbs:
  node: circleci/node@7.2.1  # Node.jsãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆç”¨ã®orb

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œé †åºã‚’å®šç¾©
workflows:
  testing:
    jobs:
      # Self-hosted Runnerã§å®Ÿè¡Œã•ã‚Œã‚‹ç°¡å˜ãªãƒ‡ãƒ¢ã‚¸ãƒ§ãƒ–
      - runner-hello
      
      # Self-hosted Runnerã§Node.js Orbã‚’ä½¿ã£ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã‚¸ãƒ§ãƒ–
      - runner-test-with-orb
      
      # CircleCIæ¨™æº–ã®ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã‚‹Node.jsãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–ï¼ˆæ¯”è¼ƒç”¨ï¼‰
      - node/test:
          pkg-manager: npm
          run-command: test:ci

# ã‚¸ãƒ§ãƒ–å®šç¾©
jobs:
  # Self-hosted Runner ç°¡å˜ãªãƒ‡ãƒ¢ã‚¸ãƒ§ãƒ–
  # RunnerãŒæ­£ã—ãå‹•ä½œã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®æœ€å°é™ã®ã‚¸ãƒ§ãƒ–
  runner-hello:
    # machine: trueã¯ã€Docker Executorã§ã¯ãªãå°‚ç”¨ã®ãƒã‚·ãƒ³ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’æŒ‡å®š
    machine: true
    
    # âš ï¸ é‡è¦: resource_classã‚’å®Ÿéš›ã«ä½œæˆã—ãŸRunner Resource Classã«ç½®ãæ›ãˆã¦ãã ã•ã„
    # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: <namespace>/<resource-class-name>
    # ä¾‹: your-org/my-runner, your-company/production-runner
    resource_class: hidetaka/first-local-runner
    
    steps:
      # Self-hosted Runnerä¸Šã§å®Ÿè¡Œã•ã‚Œã‚‹ç°¡å˜ãªãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰
      - run: echo "Hi I'm on Runners!"
      
      # è¿½åŠ ã®ã‚¹ãƒ†ãƒƒãƒ—ä¾‹ï¼ˆå¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã—ã¦ä½¿ç”¨ï¼‰:
      # - run: 
      #     name: ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã®è¡¨ç¤º
      #     command: |
      #       echo "Hostname: $(hostname)"
      #       echo "OS: $(uname -a)"

  # Self-hosted Runner + Node.js Orb ã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–
  # node/testã‚¸ãƒ§ãƒ–ã¨åŒç­‰ã®å‡¦ç†ã‚’Self-hosted Runnerä¸Šã§å®Ÿè¡Œ
  runner-test-with-orb:
    # machine: trueã¯ã€Docker Executorã§ã¯ãªãå°‚ç”¨ã®ãƒã‚·ãƒ³ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’æŒ‡å®š
    machine: true
    
    # âš ï¸ é‡è¦: resource_classã‚’å®Ÿéš›ã«ä½œæˆã—ãŸRunner Resource Classã«ç½®ãæ›ãˆã¦ãã ã•ã„
    # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: <namespace>/<resource-class-name>
    # ä¾‹: your-org/my-runner, your-company/production-runner
    resource_class: hidetaka/first-local-runner
    
    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - checkout

      # fnm (ãƒ¦ãƒ¼ã‚¶ãƒ¼é ˜åŸŸ) ã® Node/npm ã‚’ã€éãƒ­ã‚°ã‚¤ãƒ³ã‚·ã‚§ãƒ«ç’°å¢ƒã§ã‚‚ç¢ºå®Ÿã«ä½¿ãˆã‚‹ã‚ˆã†ã«åˆæœŸåŒ–
      # é‡è¦: orb ã® node/install-packages ã‚ˆã‚Šå‰ã«å®Ÿè¡Œã—ã¦ npm ã‚’è§£æ±ºå¯èƒ½ã«ã™ã‚‹
      - run:
          name: Initialize fnm (Node/npm)
          command: |
            set -euo pipefail

            # fnm ã®é…ç½®ã¯ç’°å¢ƒã«ã‚ˆã‚Šç•°ãªã‚‹ãŸã‚ã€ã¾ãšã¯ä¸€èˆ¬çš„ãªå ´æ‰€ã‚’ PATH ã«è¿½åŠ 
            if [ -d "$HOME/.fnm" ]; then
              echo 'export PATH="$HOME/.fnm:$PATH"' >> "$BASH_ENV"
            fi

            # å„ã‚¹ãƒ†ãƒƒãƒ—é–‹å§‹æ™‚ã« BASH_ENV ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ãŸã‚ã€ã“ã“ã« fnm env ã‚’æ°¸ç¶šåŒ–
            # bash ã§å‹•ãã“ã¨ã‚’æ˜ç¤ºï¼ˆCircleCI ã® run ã¯ /bin/bash ãŒå¤šã„ï¼‰
            echo 'if command -v fnm >/dev/null 2>&1; then eval "$(fnm env --shell bash)"; fi' >> "$BASH_ENV"

            # ã“ã®ã‚¹ãƒ†ãƒƒãƒ—å†…ã§ã‚‚æœ‰åŠ¹åŒ–ã—ã¦æ¤œè¨¼ãƒ­ã‚°ã‚’å‡ºã™
            source "$BASH_ENV"
            command -v fnm
            fnm --version
            node -v
            npm -v
            which npm
      
      # Node.js Orbã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # node/install-packagesã¯ã€package-lock.json/yarn.lockç­‰ã‚’æ¤œå‡ºã—ã€
      # é©åˆ‡ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
      - node/install-packages:
          pkg-manager: npm
      
      # ã‚¯ãƒ©ã‚¦ãƒ‰ç’°å¢ƒã¨åŒã˜ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
      - run:
          name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          command: npm run test:ci
      
      # è¿½åŠ ã®ã‚¹ãƒ†ãƒƒãƒ—ä¾‹ï¼ˆå¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã—ã¦ä½¿ç”¨ï¼‰:
      # - run:
      #     name: ã‚«ã‚¹ã‚¿ãƒ ãƒ“ãƒ«ãƒ‰å‡¦ç†
      #     command: npm run build
